<?xml version="1.0" encoding="UTF-8"?>
<project default="run" basedir="." name="Lucee">

<macrodef name="echots">
	<attribute name="message"/>
	<sequential>
	  <local name="timestamp" />
	  <tstamp>
		<format property="timestamp" pattern="yyyy-MM-dd HH:mm:ss" />
	  </tstamp>
	  <echo message="---------- ${timestamp} - @{message} ----------" />
	</sequential>
  </macrodef>

<target name="run">

<echo><![CDATA[
  _____         _   ____
 |_   _|__  ___| |_| __ )  _____  __
   | |/ _ \/ __| __|  _ \ / _ \ \/ /
   | |  __/\__ \ |_| |_) | (_) >  <
   |_|\___||___/\__|____/ \___/_/\_\

]]></echo>
<echots message="start TestBox testcases"/>

<!-- TODO this is hard to debug, any errors, it just fails with zero feedback -->
<script language="CFML">
<![CDATA[
encodeForHTML("abc"); // test if ESAPI extension exist right away
systemOutput("---------- #DateTimeFormat(now(),'yyyy-mm-dd HH:nn:ss')# - Lucee Started ----------", true);
request._start = getTickCount();
if (execute) {

request.basedir = basedir;
request.srcall = srcall;
request.testFilter = ListToArray( trim( testFilter ) );
request.testFolder = test;

request.WEBADMINPASSWORD = "webweb";
request.SERVERADMINPASSWORD = "webweb";
server.WEBADMINPASSWORD = request.WEBADMINPASSWORD;
server.SERVERADMINPASSWORD = request.SERVERADMINPASSWORD;

NL = "
";
TAB = "	";

// this isn't used ???
fixCase = {};
for (el in ["bundleId", "debugBuffer", "endTime", "error", "failMessage", "failOrigin", "globalException", "name", "parentId", "path", "specStats",
	"startTime", "status", "suiteId", "suiteStats", "totalDuration", "totalError", "totalFail", "totalPass", "totalSkipped", "totalSpecs", "totalSuites"]) {
	fixCase[ucase(el)] = el;
}

try {

	function mem(type) {
		var qry = getMemoryUsage(type);
		loop query=qry {
			var perc = int(100 / qry.max * qry.used);
			if(qry.max<0 || qry.used<0 || perc<90)
				continue;
			systemOutput(TAB & replace(ucFirst(type), '_', ' ') & " " & qry.name & ": " & perc & "%", true);
		}
	}

	// set a password for the admin
	try {
		admin
			action="updatePassword"
			type="web"
			oldPassword=""
			newPassword="#request.WEBADMINPASSWORD#";
	}
	catch(e){}	// may exist from previous execution

	try {
		admin
			action="updatePassword"
			type="server"
			oldPassword=""
			newPassword="#request.SERVERADMINPASSWORD#";
	}
	catch(e){}	// may exist from previous execution

	systemOutput( "set admin password #dateTimeFormat(now())#", true );

	if ( Arraylen(request.testFilter) gt 0 )
		systemOutput( NL & "Filtering only tests containing: " & request.testFilter.toJson() & NL, true );
	else
		systemOutput( NL & 'Running all tests, to run a subset of test(s), use the parameter -DtestFilter="image,orm,etc"'& NL, true );

	// output deploy log
	pc = getPageContext();
	config = pc.getConfig();
	configDir = config.getConfigServerDir();
	logsDir = configDir & server.separator.file & "logs";
	deployLog = logsDir & server.separator.file & "deploy.log";
	//dump(deployLog);
	content = fileRead( deployLog );
	systemOutput("-------------- Deploy.Log ------------",true);
	systemOutput( content, true );
	systemOutput("--------------------------------------",true);


	// create "/test" mapping
	admin
		action="updateMapping"
		type="web"
		password="#request.WEBADMINPASSWORD#"
		virtual="/test"
		physical="#test#"
		toplevel="true"
		archive=""
		primary="physical"
		trusted="no";

	systemOutput("set /test mapping #dateTimeFormat(now())#", true);

	// you can also provide a json file with your environment variables, i.e. just set LUCEE_BUILD_ENV="c:\work\lucee\loader\env.json"
	setupTestServices = new test._setupTestServices().setup();

	// set the testbox mapping
	application
		action="update"
		componentpaths = "#[{archive:testboxArchive}]#";

	systemOutput( "update componentpaths #dateTimeFormat( now() )#" & NL, true );

	// load testbox
	SystemOut = createObject( "java", "lucee.commons.lang.SystemOut" );
	out = SystemOut.setOut( nullValue() );
	//err = SystemOut.setErr( nullValue() );

	request._tick = getTickCount();
	request.overhead = [];

	admin
		action="getMappings"
		type="web"
		password="#request.WEBADMINPASSWORD#"
		returnVariable="mappings";

	systemOutput("-------------- Mappings --------------", true);
	loop query="mappings" {
		systemOutput("#mappings.virtual# #TAB# #mappings.strPhysical# "
			& (len(mappings.strArchive) ? "[#mappings.strArchive#] " : "")
			& (len(mappings.inspect) ? "(#mappings.inspect#)" : ""), true);
	}

	systemOutput(NL & "-------------- Start Tests -----------", true);
	silent {
		try {
			testResults = new test._testRunner().runTests();
		} catch(e) {
			testResults = {};
			systemOutput( cfcatch.message, true );
		}
	}
	echo( NL & NL & "---------- post test result #structKeyList(testResults)# ----------------" & NL ); // DEBUG, full run doesn't get here?
	result = testResults.result;
	failedTestcases = testResults.failedTestcases;
	tb = testResults.tb;

	echo(NL & NL & "=============================================================" & NL);
	echo("TestBox Version: #tb.getVersion()#" & NL);
	echo("Lucee Version: #server.lucee.version#" & NL);
	echo("Java Version: #server.java.version#" & NL);
	echo("Total Execution time: (#NumberFormat( ( getTickCount()-request._start) / 1000 )# s)" & NL);
	echo("Test Execution time: (#NumberFormat( result.getTotalDuration() /1000 )# s)" & NL);
	echo("Average Test Overhead: (#NumberFormat( ArrayAvg( request.overhead ) )# ms)" & NL);
	echo("Total Test Overhead: (#NumberFormat( ArraySum( request.overhead ) )# ms)" & NL);

	echo("=============================================================" & NL & NL);
	echo("-> Bundles/Suites/Specs: #result.getTotalBundles()#/#result.getTotalSuites()#/#result.getTotalSpecs()#" & NL);
	echo("-> Pass:     #result.getTotalPass()#" & NL);
	echo("-> Skipped:  #result.getTotalSkipped()#" & NL);
	echo("-> Failures: #result.getTotalFail()#" & NL);
	echo("-> Errors:   #result.getTotalError()#" & NL);

	servicesReport = new test._setupTestServices().reportServiceSkipped();
	for (s in servicesReport){
		echo ( s & NL );
	}

	if ( !isEmpty( failedTestCases ) ){
		echo( NL );
		for ( el in failedTestCases ){
			echo( el.type & ": " & el.bundle & NL & TAB & el.testCase & NL );
			echo( TAB & el.errMessage & NL );
			if ( !isEmpty( el.stackTrace ) ){
				//echo(TAB & TAB & "at" & NL);
				for ( frame in el.stackTrace ){
					echo( TAB & TAB & frame & NL );
				}
			}
			echo( NL );
		}
		echo( NL );
	}

	if ( ( result.getTotalFail() + result.getTotalError() ) > 0 ) {
		throw "TestBox could not successfully execute all testcases: #result.getTotalFail()# tests failed; #result.getTotalError()# tests errored.";
	}
} catch( e ){
	echo( "-------------------------------------------------------" & NL );
	echo( "Testcase failed:" & NL );
	echo( e.message & NL );
	echo( ReReplace( Serialize( e ), "[\r\n]\s*([\r\n]|\Z)", Chr( 10 ) , "ALL" ) & NL ); // avoid too much whitespace from dump
	echo( "-------------------------------------------------------" & NL );
	rethrow;
}

} // if (execute)
]]>
  </script>

</target>
</project>
